{% extends "base.html" %}
{% block title %}Dashboard de Produ√ß√£o{% endblock %}

{% block content %}
<div class="container-fluid mt-2 px-4">

    <!-- Cabe√ßalho -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="fw-bold text-primary mb-0">üìä Dashboard de Produ√ß√£o</h2>

        <div class="filtros-container mt-2">

            <!-- Bot√µes de Setor -->
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PTH')">PTH</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('SMT')">SMT</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('IM')">IM</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PA')">PA</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('ESTOQUE')">Estoque</button>
                <button type="button" class="btn btn-outline-secondary btn-sm fw-bold btn-setor" onclick="filterBySetor('TODOS')">Mostrar Todos</button>
            </div>

            <form id="searchForm" class="d-inline-flex ms-3">
                <input type="text" id="searchInput" class="form-control form-control-sm me-2" placeholder="Buscar por...">
                <!--<button type="submit" class="btn btn-outline-primary">Buscar</button> -->
            </form>
        </div>
    </div>

    <!-- Filtros de status -->
    <div class="d-flex justify-content-start flex-wrap gap-2 mb-2 align-items-center">
        <button type="button" class="btn btn-outline-warning btn-sm fw-bold btn-status" onclick="filterByStatus('AGUARDANDO')">üïì Aguardando</button>
        <button type="button" class="btn btn-outline-success btn-sm fw-bold btn-status" onclick="filterByStatus('DISPONIVEL')">‚úÖ Dispon√≠vel</button>
        <button type="button" class="btn btn-outline-info btn-sm fw-bold btn-status" onclick="filterByStatus('QUALIDADE')">üîç Qualidade</button>
        <button type="button" class="btn btn-outline-secondary btn-sm fw-bold btn-status" onclick="filterByStatus('TODOS')">Mostrar Todos</button>

        <!-- SELECT CLIENTES -->
        <select id="clienteSelect" class="form-select form-select-sm fw-bold ms-2" style="width: 200px;"
                onchange="filterByCliente(this.value)">
            <option value="TODOS">CLIENTES: TODOS</option>

            {% set clientes_unicos = data | map(attribute='model.cliente') | list | unique %}
            {% for cliente in clientes_unicos %}
                <option value="{{ cliente|upper }}">{{ cliente }}</option>
            {% endfor %}
        </select>

        <!-- SELECTS TOP/BOTTOM -->
        <select id="filterTopSelect" class="form-select form-select-sm fw-bold ms-2" style="width: 200px;"
                onchange="filterTop(this.value)">
            <option value="ALL">FASE TOP: TODOS</option>
            <option value="ZERO">PRODU√á√ÉO PENDENTE</option>
            <option value="COMPLETE">TOP PRONTO</option>
        </select>

        <select id="filterBottomSelect" class="form-select form-select-sm fw-bold ms-2" style="width: 200px;"
                onchange="filterBottom(this.value)">
            <option value="ALL">FASE BOTTOM: TODOS</option>
            <option value="ZERO">PRODU√á√ÉO PENDENTE</option>
            <option value="COMPLETE">BOTTOM PRONTO</option>
        </select>

        <!-- NOVO SELECT QC -->
        <select id="filterQCSelect" class="form-select form-select-sm fw-bold ms-2" style="width: 200px;"
                onchange="filterQC(this.value)">
            <option value="ALL">OQC: TODOS</option>
            <option value="ZERO">PENDENTE</option>
            <option value="COMPLETE">LIBERADO</option>
        </select>

    </div>

    <div id="totalGeralBox" style="background-color: #cce5ff; color: #004085; font-weight: bold; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
        Total Geral: 0
    </div>

<!-- Tabela -->
<div class="table-responsive shadow-sm rounded-4 bg-light p-3">
    <table class="table table-hover table-bordered align-middle" id="dashboardTable">
        <thead class="table-primary text-center">
        <tr>
            <th>Cliente</th>
            <th>Modelo</th>
            <th>C√≥digo</th>
            <th>OP</th>
            <th>Lote</th>
            <th>Status</th>
            <th>Tipo de Fase</th>
            <th>Top</th>
            <th>Bottom</th>
            <th>Saldo/Etiqueta</th>
        </tr>
        </thead>
        <tbody>
            {% for item in data %}
                {% for saldo in item.saldo_setores %}
                <tr class="text-center"
                    data-setor="{{ saldo.setor }}"
                    data-status="
                    {% if saldo.fase in ['PENDENTE CQ', 'CQ APROVOU'] %}QUALIDADE
                    {% else %}{{ saldo.status }}{% endif %}"
                    data-qc="{% if saldo.fase == 'PENDENTE CQ' %}PENDENTE{% elif saldo.fase == 'CQ APROVOU' %}LIBERADO{% else %}OUTRO{% endif %}"
                    data-topdone="{{ saldo.status_top.split('/')[0].replace(' (','') }}"
                    data-bottomdone="{% if item.model.phase_type.strip().upper() == 'TOP_ONLY' %}N/A{% else %}{{ saldo.status_bottom.split('/')[0].replace(' (','') }}{% endif %}"
                    data-total="{{ (saldo.status_top.split('/')[1] if '/' in saldo.status_top else saldo.saldo_blank) | replace(')','') }}">

                    <td class="fw-bold">{{ item.model.cliente }}</td>
                    <td class="fw-bold">{{ item.model.model_name }}</td>
                    <td class="fw-bold">{{ item.model.code }}</td>
                    <td class="fw-bold text-primary">{{ item.model.op }}</td>
                    <td class="fw-bold">{{ item.model.po }}</td>

                    <td>
                        {% if saldo.status == "AGUARDANDO" %}
                            <span class="badge bg-warning text-dark">{{ saldo.fase }}</span>
                        {% elif saldo.status == "DISPONIVEL" %}
                            <span class="badge bg-success">{{ saldo.fase }}</span>
                        {% elif saldo.status == "QUALIDADE" %}
                            <span class="badge bg-info text-dark">{{ saldo.fase }}</span>
                        {% else %}
                            <span class="badge bg-info text-dark">{{ saldo.fase }}</span>
                        {% endif %}
                    </td>

                    <td class="fw-bold">{{ item.model.phase_type.replace('_', ' ') }}</td>

                    <td class="fw-bold text-center">{{ saldo.status_top }}</td>

                    <td class="fw-bold text-center">
                        {% if item.model.phase_type.strip().upper() == "TOP_ONLY" %}
                            <span class="text-muted">N/A</span>
                        {% else %}
                            {{ saldo.status_bottom }}
                        {% endif %}
                    </td>

                    <td class="fw-bold text-center">{{ saldo.saldo_blank }}</td>

                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>

    </table>
</div>

</div>

<script>
let currentSetor = 'PTH';
let currentStatus = 'DISPONIVEL';
let currentSearch = '';
let currentCliente = 'TODOS';

let currentTopFilter = "ALL";
let currentBottomFilter = "ALL";
let currentQCFilter = "ALL";

function normalize(value) {
    return (value || "").toString().trim().toUpperCase();
}

function getRows() {
    return Array.from(document.querySelectorAll('#dashboardTable tbody tr'));
}

function applyFilters() {
    const rows = getRows();

    const topSelectVal = (document.getElementById('filterTopSelect') || {}).value || 'ALL';
    const bottomSelectVal = (document.getElementById('filterBottomSelect') || {}).value || 'ALL';

    rows.forEach(row => {
        const rowSetor = normalize(row.dataset.setor);
        const rowStatus = normalize(row.dataset.status);
        const rowQC = normalize(row.dataset.qc);
        const rowText = normalize(row.innerText);
        const rowCliente = normalize(row.querySelector('td:nth-child(1)').innerText);

        const okSetor = currentSetor === "TODOS" || rowSetor === currentSetor;
        const okStatus = currentStatus === "TODOS" || rowStatus === currentStatus;
        const okCliente = currentCliente === "TODOS" || rowCliente === currentCliente;
        const okSearch = currentSearch === "" || rowText.includes(currentSearch);

        const rowTopDone = parseInt(row.dataset.topdone) || 0;
        const rowBottomDone = row.dataset.bottomdone === "N/A" ? "N/A" : (parseInt(row.dataset.bottomdone) || 0);
        const total = parseInt(row.dataset.total) || 0;

        let okTop = true;
        if (topSelectVal === "ZERO") okTop = (rowTopDone === 0);
        if (topSelectVal === "COMPLETE") okTop = (total > 0 && rowTopDone === total);

        let okBottom = true;
        if (rowBottomDone !== "N/A") {
            if (bottomSelectVal === "ZERO") okBottom = (rowBottomDone === 0);
            if (bottomSelectVal === "COMPLETE") okBottom = (total > 0 && rowBottomDone === total);
        }

        // FILTRO QC
        let okQC = true;
        if (currentQCFilter === "ZERO") okQC = (rowQC === "PENDENTE");
        if (currentQCFilter === "COMPLETE") okQC = (rowQC === "LIBERADO");

        row.style.display =
            (okSetor && okStatus && okCliente && okSearch && okTop && okBottom && okQC)
            ? '' : 'none';
    });

    calcularTotalGeral();
}

function filterBySetor(setor) {
    currentSetor = normalize(setor);
    setActiveSetorBtn(setor);
    applyFilters();
}

function filterByStatus(status) {
    currentStatus = normalize(status);
    setActiveStatusBtn(status);
    applyFilters();
}

function filterTop(option) {
    currentTopFilter = option;
    applyFilters();
}

function filterBottom(option) {
    currentBottomFilter = option;
    applyFilters();
}

function filterQC(option) {
    currentQCFilter = option;
    applyFilters();
}

document.addEventListener("DOMContentLoaded", () => {

    const form = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");
    document.getElementById("clienteSelect").value = "TODOS";

    form.addEventListener("submit", function (e) {
        e.preventDefault();
        currentSearch = normalize(searchInput.value);
        applyFilters();
    });

    searchInput.addEventListener("input", function () {
        currentSearch = normalize(searchInput.value);
        applyFilters();
    });

    setActiveSetorBtn('PTH');
    setActiveStatusBtn('DISPONIVEL');

    applyFilters();
});

function setActiveSetorBtn(setor) {
    document.querySelectorAll('.btn-setor').forEach(btn => btn.classList.remove('active'));
    const btn = document.querySelector(`[onclick="filterBySetor('${setor}')"]`);
    if (btn) btn.classList.add('active');
}

function setActiveStatusBtn(status) {
    document.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('active'));
    const btn = document.querySelector(`[onclick="filterByStatus('${status}')"]`);
    if (btn) btn.classList.add('active');
}

function filterByCliente(cliente) {
    currentCliente = normalize(cliente);
    applyFilters();
}

function calcularTotalGeral() {
    let total = 0;
    getRows().forEach(row => {
        if (row.style.display !== 'none') {
            const saldo = parseInt(row.querySelector('td:nth-child(10)').innerText) || 0;
            total += saldo;
        }
    });
    document.getElementById("totalGeralBox").innerText = "Total Geral: " + total;
}
</script>

<script>
async function atualizarDashboardAuto() {
    try {
        const resp = await fetch("/api/dashboard");
        const data = await resp.json();

        const tbody = document.querySelector("#dashboardTable tbody");
        tbody.innerHTML = "";

        data.forEach(item => {
            item.saldo_setores.forEach(saldo => {

                const fase = (saldo.fase || "").toUpperCase();
                let status = "AGUARDANDO";

                if (fase === "DISPONIVEL") status = "DISPONIVEL";
                else if (fase.includes("CQ")) status = "QUALIDADE";

                const tr = document.createElement("tr");
                tr.className = "text-center";

                tr.dataset.setor = saldo.setor || "SEM SETOR";
                tr.dataset.status = status;
                tr.dataset.qc =
                    fase === "PENDENTE CQ" ? "PENDENTE" :
                    fase === "CQ APROVOU" ? "LIBERADO" : "OUTRO";

                tr.dataset.topdone = parseInt(saldo.status_top?.match(/\d+/)?.[0] || 0);
                tr.dataset.bottomdone =
                    saldo.status_bottom === "N/A"
                        ? "N/A"
                        : parseInt(saldo.status_bottom?.match(/\d+/)?.[0] || 0);

                tr.dataset.total = parseInt(saldo.saldo_blank || 0);

                tr.innerHTML = `
                    <td class="fw-bold">${item.model.cliente}</td>
                    <td class="fw-bold">${item.model.model_name}</td>
                    <td class="fw-bold">${item.model.code}</td>
                    <td class="fw-bold text-primary">${item.model.op}</td>
                    <td class="fw-bold">${item.model.po || ""}</td>

                    <td><span class="badge bg-info text-dark">${saldo.fase}</span></td>

                    <td class="fw-bold">${item.model.phase_type.replace("_", " ")}</td>
                    <td class="fw-bold">${saldo.status_top}</td>
                    <td class="fw-bold">${saldo.status_bottom || "N/A"}</td>
                    <td class="fw-bold">${saldo.saldo_blank}</td>
                `;

                tbody.appendChild(tr);
            });
        });

        // reaplica filtros e total
        applyFilters();

    } catch (err) {
        console.error("Erro ao atualizar dashboard:", err);
    }
}

// üîÅ atualiza a cada 5 segundos
setInterval(atualizarDashboardAuto, 5000);
</script>



{% endblock %}
