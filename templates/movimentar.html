{% extends "base.html" %}
{% block title %}Movimentar Etiqueta{% endblock %}
{% set show_header_content = true %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="container mb-3" style="max-width: 760px;">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show fw-bold shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if hide_top_menu %}
<div class="text-center mb-3 menu-movimentar-desktop">

    <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm mx-1"><strong>Ordens de Produ√ß√£o</strong></a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm mx-1"><strong>Dashboard</strong></a>
    <a href="{{ url_for('movimentar') }}" class="btn btn-outline-warning btn-sm mx-1"><strong>Movimentar</strong></a>
    <a href="#" class="btn btn-outline-success btn-sm mx-1"><strong>Configura√ß√µes</strong></a>
</div>
<hr>
{% endif %}

<style>
.action-btn.active,
.phase-btn.active {
    border: 3px solid hwb(0 0% 100%);
    background-color: #07090c !important;  
    color: white !important;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
}
</style>

<div class="container mt-4" style="max-width: 760px;">
    <h2 class="mb-4 text-center fw-bold text-primary">üì¶ Terminal de Movimenta√ß√£o</h2>

    <form action="{{ url_for('movimentar') }}" method="post" class="card p-4 shadow-sm border-0 rounded-4 bg-light">

        <input type="hidden" name="ponto_url" value="{{ request.args.get('p') or request.args.get('ponto') }}">

        <div class="mb-4">
            <label for="qr_code" class="form-label fw-bold">Bipe o QR Code:</label>
            <input type="text"
                   name="qr_code"
                   id="qr_code"
                   class="form-control form-control-lg text-center"
                   placeholder="Bipe o QR Code aqui"
                   value="{{ clean_display_code }}"
                   required
                   autofocus>
        </div>

        <div class="mb-4">
            <label for="ponto" class="form-label fw-bold">Ponto de Marca√ß√£o:</label>
            <select name="ponto" id="ponto" class="form-select form-select-lg" required>
                <option value="">-- Escolher Ponto --</option>
                <option value="Ponto-01">Ponto-01 ‚Ä¢ PTH </option>
                <option value="Ponto-02">Ponto-02 ‚Ä¢ SMT </option>
                <option value="Ponto-03">Ponto-03 ‚Ä¢ SMT (CQ)</option>
                <option value="Ponto-04">Ponto-04 ‚Ä¢ IM/PA </option>
                <option value="Ponto-05">Ponto-05 ‚Ä¢ IM/PA (CQ)</option>
                <option value="Ponto-06">Ponto-06 ‚Ä¢ IM/PA (CQ)</option>
                <option value="Ponto-07">Ponto-07 ‚Ä¢ Estoque</option>
            </select>
        </div>

        <!-- GRUPO DAS A√á√ïES -->
        <div class="mb-3 fw-bold">Selecione a A√ß√£o:</div>
        <div class="row g-2">
            <div class="col-4">
                <button type="button" class="btn btn-primary btn-lg w-100 py-4 action-btn" data-value="producao">‚úÖ Produ√ß√£o</button>
            </div>
            <div class="col-4">
                <button type="button" class="btn btn-success btn-lg w-100 py-4 action-btn" data-value="recebimento">üì• Recebimento</button>
            </div>
            <div class="col-4">
                <button type="button" class="btn btn-warning btn-lg w-100 py-4 action-btn" data-value="cq">üß™ CQ / Liberar</button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-secondary btn-lg w-100 py-4 action-btn" data-value="retrabalho">‚ôª Retrabalho</button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-danger btn-lg w-100 py-4 action-btn" data-value="rejeicao">üõë Rejei√ß√£o</button>
            </div>
        </div>

        <!-- GRUPO TOP/BOTTOM -->
        <div class="mt-4 mb-2 fw-bold">Selecione a Fase:</div>
        <div class="row g-2">
            <div class="col-6">
                <button type="button"
                        class="btn btn-info btn-lg w-100 py-4 phase-btn"
                        data-phase="top">
                    üîù FASE TOP
                </button>
            </div>

    <div class="col-6">
        <button type="button"
                class="btn btn-purple btn-lg w-100 py-4 phase-btn"
                data-phase="bottom">
            ‚¨áÔ∏è FASE BOTTOM
        </button>
    </div>
</div>

        <input type="hidden" name="acao" id="acao">
        <input type="hidden" name="top_mark" id="top_mark" value="0">
        <input type="hidden" name="bottom_mark" id="bottom_mark" value="0">

        <div class="mb-3 mt-4">
            <label for="quantidade" class="form-label fw-bold">Quantidade (opcional):</label>
            <input type="number" name="quantidade" id="quantidade"
                   class="form-control form-control-lg text-center" min="1"
                   placeholder="Vazio = Quantidade da etiqueta">
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold py-3 mt-3">
            Registrar Movimenta√ß√£o
        </button>
    </form>

    {% if label %}
    <div class="card shadow-sm border-0 rounded-4 mt-4">
        <div class="card-header bg-dark text-white fw-bold rounded-top-4">
            üìÑ Informa√ß√µes da Etiqueta
        </div>
        <div class="card-body">
            <p><strong>Modelo:</strong> {{ model['code'] }}</p>
            <p><strong>Lote:</strong> {{ label['lote'] }}</p>
            <p><strong>Setor atual:</strong> {{ label['setor_atual'] }}</p>
            <p><strong>Fase:</strong> {{ label['fase'] }}</p>
            <p><strong>Qtd dispon√≠vel:</strong> {{ label['remaining'] }}</p>

            {% if label['top_done'] is not none %}
            <p><strong>Processamento:</strong>
                TOP={{ label['top_done'] }} |
                BOTTOM={{ label['bottom_done'] }}
            </p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const acaoHidden = document.getElementById("acao");
    const topHidden = document.getElementById("top_mark");
    const bottomHidden = document.getElementById("bottom_mark");

    document.querySelectorAll(".action-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".action-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            acaoHidden.value = btn.dataset.value;
        });
    });

    document.querySelectorAll(".phase-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const phase = btn.dataset.phase;

            if (phase === "top") {
                topHidden.value = 1;
                bottomHidden.value = 0;
            } else if (phase === "bottom") {
                topHidden.value = 0;
                bottomHidden.value = 1;
            }

            document.querySelectorAll(".phase-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });

    const form = document.querySelector("form");
    form.addEventListener("submit", () => {
        if (parseInt(topHidden.value) === 1 && parseInt(bottomHidden.value) === 1) {
            bottomHidden.value = 0;
        }
        if (parseInt(topHidden.value) === 0 && parseInt(bottomHidden.value) === 0) {
            alert("Escolha uma fase: TOP ou BOTTOM!");
            event.preventDefault();
        }
    });
});
</script>


{% endblock %}
