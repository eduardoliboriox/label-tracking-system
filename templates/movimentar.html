{% extends "base.html" %}
{% block title %}Movimentar Etiqueta{% endblock %}
{% set show_header_content = true %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="container mb-3" style="max-width: 760px;">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show fw-bold shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if hide_top_menu %}
<div class="text-center mb-3">
    <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm mx-1"><strong>Ordens de ProduÃ§Ã£o</strong></a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm mx-1"><strong>Dashboard</strong></a>
    <a href="{{ url_for('movimentar') }}" class="btn btn-outline-warning btn-sm mx-1"><strong>Movimentar</strong></a>
    <a href="#" class="btn btn-outline-success btn-sm mx-1"><strong>ConfiguraÃ§Ãµes</strong></a>
</div>
<hr>
{% endif %}

<style>
/* Destaca o botÃ£o selecionado */
.action-btn.active {
    border: 3px solid hwb(216 9% 81%); /* azul primÃ¡rio do Bootstrap */
    background-color: #2f4363 !important;
    color: white !important;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
}
</style>

<div class="container mt-4" style="max-width: 760px;">
    <h2 class="mb-4 text-center fw-bold text-primary">ðŸ“¦ Terminal de MovimentaÃ§Ã£o</h2>

    <!-- FormulÃ¡rio principal -->
    <form action="{{ url_for('movimentar') }}" method="post" class="card p-4 shadow-sm border-0 rounded-4 bg-light">
        <input type="hidden" name="ponto_url" value="{{ request.args.get('p') or request.args.get('ponto') }}">
        
        <!-- QR CODE -->
        <div class="mb-4">
            <label for="qr_code" class="form-label fw-bold">Bipe o QR Code:</label>
            <input type="text" name="qr_code" id="qr_code" class="form-control form-control-lg text-center"
                   placeholder="Bipe o QR Code aqui" required autofocus>
        </div>

        <!-- PONTO -->
        <div class="mb-4">
            <label for="ponto" class="form-label fw-bold">Ponto de MarcaÃ§Ã£o:</label>
            <select name="ponto" id="ponto" class="form-select form-select-lg" required>
                <option value="">-- Escolher Ponto --</option>
                <option value="Ponto-01">Ponto-01 â€¢ PTH </option>
                <option value="Ponto-02">Ponto-02 â€¢ SMT </option>
                <option value="Ponto-03">Ponto-03 â€¢ SMT (CQ)</option>
                <option value="Ponto-04">Ponto-04 â€¢ IM/PA </option>
                <option value="Ponto-05">Ponto-05 â€¢ IM/PA (CQ)</option>
                <option value="Ponto-06">Ponto-06 â€¢ IM/PA (CQ)</option>
                <option value="Ponto-07">Ponto-07 â€¢ Estoque</option>
            </select>
        </div>

        <!-- AÃ‡Ã•ES EM FORMATO DE BOTÃ•ES GRANDES -->
        <div class="mb-3 fw-bold">Selecione a AÃ§Ã£o:</div>

        <div class="row g-2 action-buttons">
            <div class="col-6">
                <button type="button" class="btn btn-primary btn-lg w-100 py-4 action-btn" data-value="producao">
                    âœ… ProduÃ§Ã£o
                </button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-success btn-lg w-100 py-4 action-btn" data-value="recebimento">
                    ðŸ“¥ Recebimento
                </button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-warning btn-lg w-100 py-4 action-btn" data-value="cq">
                    ðŸ§ª CQ / Liberar
                </button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-secondary btn-lg w-100 py-4 action-btn" data-value="retrabalho">
                    â™» Retrabalho
                </button>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-danger btn-lg w-100 py-4 action-btn" data-value="rejeicao">
                    ðŸ›‘ RejeiÃ§Ã£o
                </button>
            </div>
        </div>

        <!-- Campo oculto onde serÃ¡ armazenada a aÃ§Ã£o escolhida -->
        <input type="hidden" name="acao" id="acao">

        <!-- QUANTIDADE -->
        <div class="mb-3 mt-4">
            <label for="quantidade" class="form-label fw-bold">Quantidade (opcional):</label>
            <input type="number" name="quantidade" id="quantidade"
                   class="form-control form-control-lg text-center" min="1"
                   placeholder="Deixe vazio para usar a quantidade da etiqueta">
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold py-3 mt-3">
            Registrar MovimentaÃ§Ã£o
        </button>
    </form>

    <!-- CARTÃƒO DE INFORMAÃ‡Ã•ES DA ETIQUETA -->
    {% if label %}
    <div class="card shadow-sm border-0 rounded-4 mt-4">
        <div class="card-header bg-dark text-white fw-bold rounded-top-4">
            ðŸ“„ InformaÃ§Ãµes da Etiqueta
        </div>
        <div class="card-body">
            <p><strong>Modelo:</strong> {{ model['code'] }}</p>
            <p><strong>Lote:</strong> {{ label['lote'] }}</p>
            <p><strong>Setor atual:</strong> {{ label['setor_atual'] }}</p>
            <p><strong>Fase:</strong> {{ label['fase'] }}</p>
            <p><strong>Qtd disponÃ­vel:</strong> {{ label['remaining'] }}</p>

            {% if label['top_done'] is not none %}
            <p><strong>Processamento:</strong>
                TOP={{ label['top_done'] }} |
                BOTTOM={{ label['bottom_done'] }}
            </p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// Foco automÃ¡tico e comportamento do Enter (NÃƒO SUBMETER automaticamente)
document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('qr_code');
    const pontoSelect = document.getElementById('ponto');
    const acaoHidden = document.getElementById('acao');

    input.focus();

    // Se o scanner enviar Enter, nÃ£o submeter.
    // Em vez disso, movemos foco para o seletor de Ponto para que o operador escolha o PONTO.
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (pontoSelect && pontoSelect.value) {
                const firstAction = document.querySelector('.action-btn');
                if (firstAction) firstAction.focus();
            } else if (pontoSelect) {
                pontoSelect.focus();
            }
        }
    });

    // BotÃµes de aÃ§Ã£o -> selecionam o hidden input e (agora) NÃƒO submetem o form automaticamente;
    // em vez disso, preenche o input escondido e foca no botÃ£o 'Registrar' para permitir revisÃ£o.
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const acao = btn.getAttribute('data-value');
                document.getElementById('acao').value = acao;

                // opcional: adiciona uma classe visual de selecionado
                document.querySelectorAll('.action-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');

                // foca no botÃ£o de submit
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.focus();
            });
        });
});
</script>

{% endblock %}
