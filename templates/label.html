  {% extends "base.html" %}
  {% block content %}
  <div class="no-print mb-3">
    <form method="post" class="d-flex flex-wrap align-items-end gap-3">
      <div>
        <label class="form-label mb-1">Produção Total (placas)</label>
        <input type="number" name="producao_total" class="form-control" placeholder="Ex: 1000" required>
      </div>
      <div>
        <label class="form-label mb-1">Capacidade por Magazine</label>
        <input type="number" name="capacidade_magazine" class="form-control" placeholder="Ex: 50" required>

            <div>
        <label>Vincular a etiqueta existente (opcional)</label>
        <select name="linked_label_id" class="form-control">
          <option value="">Nenhuma</option>
          {% for l in existing_labels %}
            <option value="{{ l['id'] }}">{{ l['lote'] }} - {{ l['model_name'] }}</option>
          {% endfor %}
        </select>
      </div>
      </div>
      <button type="submit" class="btn btn-success">Gerar Etiquetas</button>
      <a class="btn btn-secondary" href="{{ url_for('index') }}">Voltar</a>
    </form>

    {% if lotes %}
      <button class="btn btn-primary mt-3" onclick="window.print()">Imprimir</button>
    {% endif %}
  </div>

  <style>

  @page {
    size: A4 landscape;
    margin: 0mm !important;
  }

  body {
    margin: 0 !important;
    padding: 0 !important;
    background: #fff;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    transform: scale(1); 
    transform-origin: top left;
  }

  * {
    box-sizing: border-box;
  }

  /* ===== PÁGINA ===== */
  .pagina {
    display: block !important;
    width: auto !important;
    max-width: none !important;
    line-height: 0;
    white-space: nowrap !important;
    /* impede quebra e deixa expandir */
  }

  .etiqueta {
    display: inline-block;
    vertical-align: top;
    margin-right: 3mm;  
    margin-bottom: 5mm;  
    width: 280mm; 
    height: auto;  
    border: 6px solid #000;
    padding: 8mm;
    background: #fff;
    font-family: Arial, sans-serif;
    font-size: 18pt;
    line-height: 1.3;
    white-space: normal;
    overflow: visible;
    page-break-inside: avoid;

    margin-bottom: 2mm;  /* pequeno espaço vertical */
  }

  /* ===== CONTEÚDO ===== */
  .titulo {
    text-align: center;
    font-weight: bold;
    font-size: 22pt;
    white-space: nowrap; /* não quebra */
  }

  .cliente {
    text-align: center;
    font-weight: bold;
    font-size: 26pt;
    margin: 5mm 0;
    text-transform: uppercase;
  }

  .etiqueta table {
    width: 100%;
    border-collapse: collapse;
    font-size: 18pt;
  }

  .etiqueta td,
  .etiqueta th {
    border: 1px solid #000;
    padding: 3mm 4mm;
    vertical-align: middle;
    word-wrap: break-word;
  }

  .qr-codigo {
    width: 60mm;
    height: 40mm;
    border: 1px solid #000;
    object-fit: contain;
  }

  .codigo-box-destaque {
    border: 3px solid #000;
    font-size: 32pt;
    font-weight: bold;
    text-align: center;
    height: 40mm;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }

  .checkbox-box {
    width: 12mm;
    height: 10mm;
    border: 1px solid #000;
    display: inline-block;
    margin: 0 3mm;
  }

  .wide-checkbox {
    width: 60mm;
    height: 10mm;
    border: 1px solid #000;
    display: inline-block;
    margin-left: 4mm;
  }

  .sem-borda td,
  .sem-borda th {
    border: none !important;
  }

  .linha-assinatura {
    display: inline-block;
    width: 100mm;       
    border-bottom: 1.5px solid #000; 
    margin-left: 5mm;  
    height: 6mm;      
  }

  @media screen {
    body {
      zoom: 0.8  /* ERA 6 */
    }
  }

  /* ===== IMPRESSÃO ===== */
  @media print {
    html, body {
      width: 297mm;
      height: 245mm;
      margin: 0;
    }

    .pagina {
      width: 297mm;
      height: 245mm;
      padding-top: 14mm !important;
      line-height: 0;
      overflow: visible;
    }

    .etiqueta {
      width: 280mm !important;  
      transform: none !important;
      zoom: 1 !important;
      page-break-inside: avoid;
    }
  }

  @media screen {
  .pagina {
    transform: scale(0.40); 
    transform-origin: top left;
  }

  body {
    overflow: auto;
  }
}

  @media print {
    body {
      margin: 0 !important;
      padding: 0 !important;
      padding-top: 13mm !important;
    }

    .pagina {
      margin: 0 !important;
      padding: 0 !important;
      padding-top: 13mm !important;
      padding-left: 14mm !important; 
      transform: none !important;
      zoom: 1.03; 
    }
  }

  </style>

  {% if request.endpoint == 'etiqueta_visualizar' %}
  <style>
    @media screen {
      body {
        zoom: 1 !important;
        transform: none !important;
        overflow: visible !important;
      }
      .pagina {
        transform: scale(0.8);
        transform-origin: top left;
      }
    }
  </style>
  {% endif %}

  {% if lotes %}
    {% set etiquetas_por_folha = 3 %}
    {% for i in range(0, lotes|length, etiquetas_por_folha) %}
    <div class="pagina">
      {% for lote_num in lotes[i:i+etiquetas_por_folha] %}
      <div class="etiqueta">
        <table style="margin-bottom:6px;">
          <tr>
            <td style="width:100px; border:none;">
              <img src="{{ url_for('static', filename='logos/logo.png') }}" style="height:60px;">
            </td>
            <td class="titulo" style="border:none;">
              ETIQUETA DE IDENTIFICAÇÃO SEMI-ACABADO
            </td>
            <td style="width:100px; border:none;"></td>
          </tr>
        </table>

        <table>
          <tr>
            <td style="width:33%;">
              <strong>Cód.:</strong> {{ m['code'].replace('_SMT','') }}<br>
              <strong>Linha:</strong> {{m['linha']}} {{m['setor'] or 'SMT'}}<br>
              <strong>Lote:</strong> {{lote_num}}<br>
              <strong>Horário:</strong> {{m['horario']}}
            </td>
            <td style="width:33%;">
              <strong>Modelo:</strong> {{m['model_name']}}<br>
              <strong>Turno:</strong> {{m['turno']}}<br>
              <strong>Quant.:</strong> {{m['quantidade']}}<br>
              <strong>Lote:</strong> {{m['po']}}
            </td>
            <td style="width:33%;">
              <strong>Data:</strong> {{m['data']}}<br>
              <strong>Revisor(a):</strong> {{m['revisora']}}<br>
              <strong>Operador(a):</strong> {{ m['operadora'] }}<br>
              <strong>OP:</strong> {{m['op']}}<br>
            </td>
          </tr>
        </table>

        {% if auto_print %}
  <script>
    window.onload = () => window.print();
  </script>
  {% endif %}

  {% if request.args.get('auto_print') %}
  <script>
    window.onload = () => window.print();
  </script>
  {% endif %}

        <div class="cliente">CLIENTE: {{ m['cliente'] or '---' }}</div>

        <table class="sem-borda">
          <tr>
            <td colspan="3">
              <strong>Alteração:</strong> SIM <span class="checkbox-box"></span>
              NÃO <span class="checkbox-box"></span>
              <strong>N° DESVIO</strong> <span class="wide-checkbox"></span>
            </td>
          </tr>
          
          <tr>
            <td colspan="3">
              <strong>Processo:</strong>
              TOP <span class="checkbox-box"></span>
              BOT <span class="checkbox-box"></span>
              AOI <span class="checkbox-box"></span>
            </td>
          </tr>
          <tr>
            <td colspan="3">
              <strong>Status CQ:</strong>
              APROVADO <span class="checkbox-box"></span>
              REJEITADO <span class="checkbox-box"></span>
              TESTE FUNCIONAL <span class="checkbox-box"></span>
            </td>
          </tr>
        </table>

        <table class="sem-borda" style="margin-top:6px; width: 100%;">
          <tr>
            <td style="width:130px;">
              <img class="qr-codigo" src="{{ url_for('qr', code=(m['code'] ~ '-' ~ lote_num.replace(' ', '').replace('/', '-'))) }}">
            </td>
            <td style="text-align: right;">
              <div class="codigo-box-destaque">{{m['code']}}</div>
            </td>
          </tr>
        </table>

        <table class="sem-borda" style="margin-top:6px;">
          <tr>
            <td><strong>Obs.:</strong> {{m['obs']}}</td>
          </tr>
          <tr>  
            <td class="text-end">
              <strong>Resp. CQ:</strong>
              <span class="linha-assinatura"></span>
            </td>
          </tr>
        </table>
      </div>
      {% endfor %}
    </div>
    {% endfor %}
  {% endif %}
  {% endblock %}
