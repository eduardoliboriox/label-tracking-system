<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Venttos Trace</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<header class="header-mobile d-md-none">
    <div class="header-mobile-left">
        <div class="avatar-circle">
            <img src="{{ url_for('static', filename='users/eduardo.jpeg') }}" alt="Avatar">
        </div>
        <div class="user-name">Eduardo</div> 
    </div>

    <!-- LADO DIREITO -->
    <div class="header-mobile-right">
        <button class="btn-search" id="btnSearch">
            <i class="bi bi-search"></i>
        </button>

        <button class="btn-notification" id="btnNotification">
            <i class="bi bi-bell-fill"></i>
        </button>
    </div>
</header>

    <!-- BUSCA MOBILE (fica escondida) -->
    <div class="mobile-search d-md-none" id="mobileSearch">
        <input type="text" placeholder="Buscar na tela..." id="searchInput">
    </div>

<!-- HEADER DESKTOP (inalterado) -->
<header class="header-sistema d-none d-md-flex align-items-center justify-content-between px-3 py-3 position-relative">
    <button id="btnDesktopMenu"
            class="btn btn-outline-secondary btn-sm me-3 d-none d-md-inline-flex">
        <i class="bi bi-list"></i>
    </button>

    <div class="header-left d-flex align-items-center">
        <img src="{{ url_for('static', filename='logos/logo-name.jpeg') }}" class="logo logo-desktop" alt="Venttos Trace">
    </div>
</header>

    <div id="desktopMenu" class="desktop-menu">
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('index') }}">Ordens de Produ√ß√£o</a>
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('movimentar') }}">Movimentar</a>
        <a href="{{ url_for('ops') }}">Controle de OPs</a>
        <a href="{{ url_for('live') }}">Ao Vivo</a>        
    </div>

    <hr class="linha-separadora">

<main class="container mt-1">
    {% block content %}{% endblock %}
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Fechar alerts automaticamente -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const alerts = document.querySelectorAll(".alert");
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 3000); 
    });
});
</script>

<!-- Toggle sidebar mobile e fechar ao clicar fora -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById('btnToggleSidebar');
    const sidebar = document.getElementById('sidebarMobile');

    if (btn && sidebar) {
        // Toggle sidebar ao clicar no bot√£o
        btn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            sidebar.classList.toggle('show');
        });

        // Fecha o sidebar ao clicar fora dele
        document.addEventListener('click', (e) => {
            if (sidebar.classList.contains('show') && 
                !sidebar.contains(e.target) && 
                !btn.contains(e.target)) {
                sidebar.classList.remove('show');
            }
        });

        sidebar.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnDesktopMenu");
    const menu = document.getElementById("desktopMenu");
    const main = document.querySelector("main");

    if (!btn || !menu || !main) return;

    function isTablet() {
        return window.innerWidth >= 768 && window.innerWidth <= 1024;
    }

    // Fecha o menu ao tocar fora (APENAS TABLET)
    document.addEventListener("click", (e) => {
        if (!isTablet()) return;

        const clicouNoBotao = btn.contains(e.target);
        const clicouNoMenu = menu.contains(e.target);

        if (!clicouNoBotao && !clicouNoMenu && menu.classList.contains("open")) {
            menu.classList.remove("open");
            localStorage.setItem("desktopMenuOpen", "false");
        }
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnDesktopMenu");
    const menu = document.getElementById("desktopMenu");

    if (!btn || !menu) return;

    // restaura estado
    if (localStorage.getItem("desktopMenuOpen") === "true") {
        menu.classList.add("open");
    }

    btn.addEventListener("click", () => {
        const aberto = menu.classList.toggle("open");
        localStorage.setItem("desktopMenuOpen", aberto);
    });
});
</script>

<!--
<footer class="footer-sistema">
    <div class="container text-center">
        <div>
            ¬© 2025{% if current_year > 2025 %}-{{ current_year }}{% endif %}
            Venttos Electronics. Venttos Trace.
        </div>
        <div>Todos os direitos reservados.</div>
    </div>
</footer>-->
<script>
(async function () {

    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        console.log('üîï Push n√£o suportado neste navegador');
        return;
    }

    try {
        // 1Ô∏è‚É£ Registra o Service Worker
        const registration = await navigator.serviceWorker.register('/static/sw.js');

        // 2Ô∏è‚É£ Pede permiss√£o
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            console.log('üîï Permiss√£o de notifica√ß√£o negada');
            return;
        }

        // 3Ô∏è‚É£ Cria subscription (se ainda n√£o existir)
        let subscription = await registration.pushManager.getSubscription();

        if (!subscription) {
            subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: '{{ VAPID_PUBLIC_KEY }}'
            });
        }

        // 4Ô∏è‚É£ Envia para o backend
        await fetch('/api/push/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(subscription)
        });

        console.log('üîî Push registrado com sucesso');

    } catch (err) {
        console.error('Erro ao registrar push:', err);
    }

})();
</script>

<script>
  const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY }}";
</script>
<script src="{{ url_for('static', filename='js/push.js') }}"></script>

 
<!-- BOTTOM MENU MOBILE nav -->
<nav class="bottom-nav d-md-none">
    <a href="{{ url_for('home') }}"
       class="bottom-item {% if request.endpoint == 'home' %}active{% endif %}">
        <img src="{{ url_for('static', filename='icons/home.jpeg') }}" class="bottom-icon">
        <small>Home</small>
    </a>

    <a href="{{ url_for('index') }}"
       class="bottom-item {% if request.endpoint == 'index' %}active{% endif %}">
        <img src="{{ url_for('static', filename='icons/ordens.jpeg') }}" class="bottom-icon">
        <small>Ordens</small>
    </a>

    <a href="{{ url_for('dashboard') }}"
       class="bottom-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
        <img src="{{ url_for('static', filename='icons/dashboard.jpeg') }}" class="bottom-icon">
        <small>Dashboard</small>
    </a>

    <a href="{{ url_for('live') }}"
       class="bottom-item {% if request.endpoint == 'live' %}active{% endif %}">
        <img src="{{ url_for('static', filename='icons/live.jpeg') }}" class="bottom-icon">
        <small>Ao Vivo</small>
    </a>

    <a href="{{ url_for('menu') }}"
       class="bottom-item bottom-more {% if request.endpoint == 'menu' %}active{% endif %}">
        <img src="{{ url_for('static', filename='icons/menu-mais.png') }}" class="bottom-icon">
        <small>Mais</small>
    </a>
</nav>

</body>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btnSearch = document.getElementById("btnSearch");
    const mobileSearch = document.getElementById("mobileSearch");
    const input = document.getElementById("searchInput");
    const headerMobile = document.querySelector(".header-mobile");

    /* ABRIR / FECHAR AO CLICAR NA LUPA */
    btnSearch.addEventListener("click", (e) => {
        e.stopPropagation();

        const aberto = mobileSearch.classList.contains("show");

        if (aberto) {
            fecharBusca();
        } else {
            mobileSearch.classList.add("show");
            mobileSearch.style.display = "block";
            setTimeout(() => input.focus(), 100);
        }
    });

    /* FECHAR AO CLICAR FORA */
    document.addEventListener("click", (e) => {
        if (
            mobileSearch.classList.contains("show") &&
            !mobileSearch.contains(e.target) &&
            !headerMobile.contains(e.target)
        ) {
            fecharBusca();
        }
    });

    /* BUSCA EM TEMPO REAL */
    input.addEventListener("input", () => {
        filtrarPagina(input.value);
    });

    function fecharBusca() {
        mobileSearch.classList.remove("show");
        mobileSearch.style.display = "none";
        input.value = "";
        filtrarPagina("");
    }

    function filtrarPagina(valor) {
        const texto = valor.toLowerCase();
        const elementos = document.querySelectorAll("main *");

        elementos.forEach(el => {
            if (el.children.length === 0) {
                el.style.display = el.innerText.toLowerCase().includes(texto)
                    ? ""
                    : "none";
            }
        });
    }

});
</script>

</html>
