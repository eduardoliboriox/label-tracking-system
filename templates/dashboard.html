{% extends "base.html" %}
{% block title %}Dashboard de ProduÃ§Ã£o{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <!-- CabeÃ§alho -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div class="d-flex align-items-center flex-wrap gap-3">
            <h2 class="fw-bold text-primary mb-0">ðŸ“Š Dashboard de ProduÃ§Ã£o</h2>
            <div class="d-flex flex-wrap gap-2 ms-3">
                <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PTH')">PTH</button>
                <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('SMT')">SMT</button>
                <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('IM')">IM</button>
                <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PA')">PA</button>
                <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('ESTOQUE')">Estoque</button>
                <button class="btn btn-outline-secondary btn-sm fw-bold btn-setor" onclick="filterBySetor('TODOS')">Mostrar Todos</button>
            </div>
        </div>
    </div>

    <!-- Filtros de status -->
    <div class="d-flex justify-content-start flex-wrap gap-2 mb-4">
        <button class="btn btn-outline-success btn-sm fw-bold btn-status" onclick="filterByStatus('AGUARDANDO')">ðŸ•“ Aguardando ProduÃ§Ã£o</button>
        <button class="btn btn-outline-info btn-sm fw-bold btn-status" onclick="filterByStatus('DISPONIVEL')">âœ… Placas DisponÃ­veis</button>
    </div>

    <!-- TOTAL GERAL -->
    <div class="alert alert-primary fw-bold mb-3" id="totalGeralBox">
        Total Geral: 0
    </div>

    <!-- Tabela -->
    <div class="table-responsive shadow-sm rounded-4 bg-light p-3">
        <table class="table table-hover align-middle" id="dashboardTable">
            <thead class="table-primary text-center">
                <tr>
                    <th>Modelo</th>
                    <th>CÃ³digo</th>
                    <th>Fase</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>,
            {% for item in data %}
                {% for saldo in item.saldo_setores %}
                <tr 
                    class="text-center"
                    data-setor="{{ saldo.setor }}"
                    data-status="{{ saldo.status }}"
                    data-fase="{{ saldo.fase }}">
                <td class="fw-bold">{{ item.model.model_name }}</td>
                <td>{{ item.model.code }}</td>
                <td class="text-center">{{ saldo.fase or '-' }}</td>
                <td class="text-center fw-semibold">{{ saldo.saldo }}</td>
                </tr>
                {% endfor %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
  // estados atuais dos filtros
  let currentSetor = 'TODOS';
  let currentStatus = 'TODOS';

  // pega todas as linhas (cache)
  const getRows = () => Array.from(document.querySelectorAll('#dashboardTable tbody tr'));

  function applyFilters() {
    const rows = getRows();
    rows.forEach(row => {
      const rowSetor = (row.dataset.setor || 'SEM SETOR').toString().trim();
      const rowStatus = (row.dataset.status || '').toString().trim();

      // condiÃ§Ã£o setor
      const okSetor = (currentSetor === 'TODOS') || (rowSetor === currentSetor);
      // condiÃ§Ã£o status
      const okStatus = (currentStatus === 'TODOS') || (rowStatus === currentStatus);

      // mostra apenas se BOTH true (interseÃ§Ã£o)
      row.style.display = (okSetor && okStatus) ? '' : 'none';
    });
    calcularTotalGeral();
  }

  // ativa/desativa classe active nos botÃµes de setor
  function setActiveSetorBtn(setor) {
    document.querySelectorAll('.btn-setor').forEach(btn => btn.classList.remove('active'));
    const clicked = document.querySelector(`[onclick="filterBySetor('${setor}')"]`);
    if (clicked) clicked.classList.add('active');
  }

  // ativa/desativa classe active nos botÃµes de status
  function setActiveStatusBtn(status) {
    document.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('active'));
    const clicked = document.querySelector(`[onclick="filterByStatus('${status}')"]`);
    if (clicked) clicked.classList.add('active');
  }

  // --- Filtro por setor (mantÃ©m estado) ---
  function filterBySetor(setor) {
    currentSetor = setor;
    setActiveSetorBtn(setor);
    applyFilters();
  }

  // --- Filtro por status (mantÃ©m estado) ---
  function filterByStatus(status) {
    currentStatus = status;
    setActiveStatusBtn(status);
    applyFilters();
  }

 function calcularTotalGeral() {
    let total = 0;
    const rows = document.querySelectorAll('#dashboardTable tbody tr');

    rows.forEach(row => {
        if (row.style.display !== 'none') {  // sÃ³ soma linhas visÃ­veis
            const saldo = parseInt(row.querySelector('td:nth-child(4)').innerText) || 0;
            total += saldo;
        }
    });

    document.getElementById("totalGeralBox").innerText = "Total Geral: " + total;
}


  // opcional: inicializa os botÃµes "Mostrar Todos" como ativos
 document.addEventListener('DOMContentLoaded', () => {
    setActiveSetorBtn('TODOS');
    setActiveStatusBtn('TODOS');
    applyFilters();
    calcularTotalGeral();   // <<< ADICIONE ESTA LINHA
});
</script>

{% endblock %}
