{% extends "base.html" %}
{% block title %}Dashboard de ProduÃ§Ã£o{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">

    <!-- CabeÃ§alho -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="fw-bold text-primary mb-0">ðŸ“Š Dashboard de ProduÃ§Ã£o</h2>

        <div class="d-flex flex-wrap gap-2 align-items-center">
            <!-- BotÃµes de Setor -->
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PTH')">PTH</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('SMT')">SMT</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('IM')">IM</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PA')">PA</button>
                <button type="button" class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('ESTOQUE')">Estoque</button>
                <button type="button" class="btn btn-outline-secondary btn-sm fw-bold btn-setor" onclick="filterBySetor('TODOS')">Mostrar Todos</button>
            </div>
            <form id="searchForm" class="d-inline-flex ms-3">
                <input type="text" id="searchInput" class="form-control me-2" placeholder="Pesquisar...">
                <button type="submit" class="btn btn-outline-primary">Buscar</button>
            </form>
        </div>
    </div>

    <!-- Filtros de status -->
    <div class="d-flex justify-content-start flex-wrap gap-2 mb-4">
        <button type="button" class="btn btn-outline-warning btn-sm fw-bold btn-status" onclick="filterByStatus('AGUARDANDO')">ðŸ•“ Aguardando</button>
        <button type="button" class="btn btn-outline-success btn-sm fw-bold btn-status" onclick="filterByStatus('DISPONIVEL')">âœ… DisponÃ­vel</button>
        <button type="button" class="btn btn-outline-info btn-sm fw-bold btn-status" onclick="filterByStatus('EXPEDIDO')">ðŸ“¦ Expedido</button>   
        <button type="button" class="btn btn-outline-secondary btn-sm fw-bold btn-status" onclick="filterByStatus('TODOS')">Mostrar Todos</button>
    </div>

    <div id="totalGeralBox" style="background-color: #cce5ff; color: #004085; font-weight: bold; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
        Total Geral: 0
    </div>

    <!-- Tabela -->
    <div class="table-responsive shadow-sm rounded-4 bg-light p-3">
        <table class="table table-hover table-bordered align-middle" id="dashboardTable">
            <thead class="table-primary text-center">
                <tr>
                    <th>Modelo</th>
                    <th>CÃ³digo</th>
                    <th>Setor</th>
                    <th>Fase</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                    {% for saldo in item.saldo_setores %}
                    <tr class="text-center" 
                        data-setor="{{ saldo.setor }}"
                        data-status="{{ saldo.status }}">
                        <td class="fw-bold">{{ item.model.model_name }}</td>
                        <td>{{ item.model.code }}</td>
                        <td>{{ saldo.setor }}</td>
                        <td>
                            {% if saldo.status == "AGUARDANDO" %}
                                <span class="badge bg-warning text-dark">{{ saldo.fase }}</span>
                            {% elif saldo.status == "DISPONIVEL" %}
                                <span class="badge bg-success">{{ saldo.fase }}</span>
                            {% elif saldo.status == "EXPEDIDO" %}
                                <span class="badge bg-info text-dark">{{ saldo.fase }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ saldo.fase }}</span>
                            {% endif %}
                        </td>
                        <td class="fw-semibold">{{ saldo.saldo }}</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
let currentSetor = 'TODOS';
let currentStatus = 'TODOS';
let currentSearch = '';

function normalize(value) {
    return (value || "").toString().trim().toUpperCase();
}

function getRows() {
    return Array.from(document.querySelectorAll('#dashboardTable tbody tr'));
}

// -----------------------------
// APLICA TODOS OS FILTROS
// -----------------------------
function applyFilters() {
    const rows = getRows();

    rows.forEach(row => {
        const rowSetor = normalize(row.dataset.setor);
        const rowStatus = normalize(row.dataset.status);
        const rowText = normalize(row.innerText);

        const okSetor = currentSetor === "TODOS" || rowSetor === currentSetor;
        const okStatus = currentStatus === "TODOS" || rowStatus === currentStatus;
        const okSearch = currentSearch === "" || rowText.includes(currentSearch);

        row.style.display = (okSetor && okStatus && okSearch) ? '' : 'none';
    });

    calcularTotalGeral();
}

// -----------------------------
// FILTROS DE SETOR
// -----------------------------
function filterBySetor(setor) {
    currentSetor = normalize(setor);
    setActiveSetorBtn(setor);
    applyFilters();
}

// -----------------------------
// FILTROS DE STATUS
// -----------------------------
function filterByStatus(status) {
    currentStatus = normalize(status);
    setActiveStatusBtn(status);
    applyFilters();
}

// -----------------------------
// CAMPO DE BUSCA (NÃƒO RECARREGA A PÃGINA)
// -----------------------------
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");

    form.addEventListener("submit", function (e) {
        e.preventDefault(); 

        currentSearch = normalize(searchInput.value);
        applyFilters();
    });

    applyFilters();
});

// -----------------------------
// ATIVA BOTÃ•ES VISUALMENTE
// -----------------------------
function setActiveSetorBtn(setor) {
    document.querySelectorAll('.btn-setor').forEach(btn => btn.classList.remove('active'));
    const btn = document.querySelector(`[onclick="filterBySetor('${setor}')"]`);
    if (btn) btn.classList.add('active');
}

function setActiveStatusBtn(status) {
    document.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('active'));
    const btn = document.querySelector(`[onclick="filterByStatus('${status}')"]`);
    if (btn) btn.classList.add('active');
}

// -----------------------------
// SOMA
// -----------------------------
function calcularTotalGeral() {
    let total = 0;
    getRows().forEach(row => {
        if (row.style.display !== 'none') {
            const saldo = parseInt(row.querySelector('td:nth-child(5)').innerText) || 0;
            total += saldo;
        }
    });
    document.getElementById("totalGeralBox").innerText = "Total Geral: " + total;
}
</script>

{% endblock %}
